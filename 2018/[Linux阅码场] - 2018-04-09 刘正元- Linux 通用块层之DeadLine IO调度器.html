<!DOCTYPE html>
<head>
	<meta http-equiv='Content-Type' content='text/html;charset=utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'>
	<title>
		刘正元- Linux 通用块层之DeadLine IO调度器
	</title>
	<script src='https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js'>
	</script>
	<style>
		a {color: #607fa6;text-decoration:none;word-wrap:break-word;word-break:break-all;}.rich_media_title{padding-bottom:10px;margin-bottom:14px;border-bottom:1px solid #e7e7eb;font-weight:400;} .rich_media_meta_list{font-size:14px;margin-bottom: 22px;}
		.rich_media_meta{display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:14px;}.rich_media_meta_text{color:#8c8c8c;color:rgba(0, 0, 0, 0.3)}.rich_media_meta_list
		em {font-style: normal;}@media screen and (max-width:768px){.rich_media{position:
		relative;padding: 20px 15px 15px;background-color: #fff;}}.rich_media_content{text-align:justify;} .rich_media_content * {max-width:100%!important;box-sizing: border-box!important;-webkit-box-sizing:
		border-box!important;word-wrap: break-word!important;}.rich_media_content
		blockquote {margin: 0;padding-left: 10px;border-left: 3px solid #dbdbdb;}.rich_media_content
		.list-paddingleft-2 {padding-left: 2.2em;}a.rich_media_meta_nickname{display: none;}@media screen and (min-width:1025px){.rich_media{position:relative;}a.rich_media_meta_nickname{display:inline-block!important;}span.rich_media_meta_nickname
		{display: inline-block!important;}.rich_media {width:677px;margin-left:auto;margin-right:auto;}}a.fwjm{font-size: 12px;color: #ececec;}.tenvideo_player {position: relative;width:
		100 %;height: 100 %;margin: auto;background: #000;}* {margin:0px;padding:0px;} body{line-height: 1.6;letter-spacing: .034em;}
		.dy_all {text-align: center;margin: 30px 0;} .dy_all a {display: inline-block;height:
		38px;line-height: 38px;padding: 0 18px;background-color: #009688;color:
		#fff;white-space: nowrap;font-size: 14px;border: none;border-radius: 2px;cursor:
		pointer;text-align: center;outline: 0;-webkit-appearance: none;transition:
		all .3s;-webkit-transition: all .3s;box-sizing: border-box;} img{max-width: 677px!important;}

		.crawler-info{padding: 8px 0;} .article-link>img{margin-left: 20px;width: 16px;}
		.comment-item::before,.comment-item::after{content:'';display:block;height:0;visibility:hidden;clear:both;*zoom:1;} .comment-item{margin-bottom:30px;}
		.avatar{width:12%; padding-right:10px;float:left;box-sizing:border-box;} .avatar img{width:100%;}
		.comment-body{float:left;width:88%;} .comment-body .comment-info{color:#b3b3b3;margin-bottom:4px;margin-top: -5px;} .comment-body .comment-info>span:last-child{float:right;} 
		.comment-author{border-left:4px solid green;padding-left:6px;margin:8px 0;}

		@media screen and (max-width: 420px) {.article-link>img {margin-left: 0px;}}
		@media screen and (min-width: 480px) {.avatar {width: 9%;}.comment-body {width: 91%;}}
	</style>
</head>
<body>
	<div id='js_article' class='rich_media'>
		<div class="crawler-info">
			<a href='https://www.52pojie.cn' class='fwjm' target='_blank'>
				提供的爬取软件来源于：52pojie.cn@夜泉 免费下载使用
			</a>
			<a href='https://mp.weixin.qq.com/s?__biz=MzAwMDUwNDgxOA==&amp;mid=2652664087&amp;idx=1&amp;sn=0c786ad24a9b9c809611e988ffc8565e&amp;chksm=810f378ab678be9cd9540b597e1d6d7e914fb4db47de2964bb1a994bc2cb777c3c548273f75e&amp;scene=27#wechat_redirect&cpage=28' target='_blank' class="article-link">
				<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAMAAABA3o1rAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjk4QUEzQzVDNkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjk4QUEzQzVENkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OThBQTNDNUE2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OThBQTNDNUI2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5TKSKsAAAAclBMVEUuLi77+/stLS1VVVXx8fFOTk7s7Ozt7e1qamp5eXlNTU2WlpZFRUU6Ojrq6urn5+d/f3/8/Pw9PT0/Pz+YmJg8PDyZmZlAQECfn5+QkJBBQUFra2vo6OhDQ0OSkpKenp5WVlY+Pj7r6+tpaWksLCz///9o6ILHAAAAJnRSTlP/////////////////////////////////////////////////AKd6gbwAAACNSURBVHjajJHpEoIwDISDVMotcnuCmLz/K9KCdlqO6v7p7Mw3yW4KxG85fnUkIVfZ5J0SsCtqcgRw0HzjQYY2AAOIdRuaK4ReAPJ5nmglL5qICahpU60C0uXguQ9TgIwGJoDnT9z/ABmxt60ot0N2CsDLfb9mvBxs9ql+n5o9bEDBgbif7/1F4g80CjAAqrVAnnsm5f8AAAAASUVORK5CYII=" />
			</a>
		</div>
		<div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">刘正元: Linux 通用块层之DeadLine IO调度器</h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                            <span id="copyright_logo" class="rich_media_meta rich_media_meta_text meta_tag_text">原创：</span>
                                                                                        <span class="rich_media_meta rich_media_meta_text">
                                                        刘正元
                                                    </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);">Linux阅码场</a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">Linux阅码场</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">LinuxDev</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">专业的Linux技术社区和Linux操作系统学习平台，内容涉及Linux内核,Linux内存管理,Linux进程管理,Linux文件系统和IO,Linux性能调优,Linux设备驱动以及Linux虚拟化和云计算等各方各面.</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2018-04-09</em>





                </div>

                
                
                                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <h2><strong><span style="font-family: 宋体;font-size: 24px;"><span style=";"></span></span></strong></h2><section style="background-color: rgb(255, 255, 255);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="margin: 10px 0%;box-sizing: border-box;"><section class="" style="display: inline-block;width: 100%;vertical-align: top;padding: 2px 3px;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_gif/Ass1lsY6byuKYhicsJHsK6mUWJ40OHGoLm4sDepTNTDN4yXkyOqS5bzE2O2ibJ7Afm57r33jLiakRfKk8QibBd2NMA/640?wx_fmt=gif&quot;);background-position: 0% 0%;background-repeat: repeat;background-size: auto;background-attachment: scroll;line-height: 1.6;box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="margin: 1px 0%;text-align: center;box-sizing: border-box;"><section class="" style="display: inline-block;width: 100%;border-width: 1px;border-style: solid;border-color: transparent;padding: 10px;background-color: rgb(254, 255, 255);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="box-sizing: border-box;"><section class="" style="text-align: left;box-sizing: border-box;"><h2 style="white-space: normal;"><strong><span style="font-family: 宋体;font-size: 15px;"></span></strong></h2><h2 style="white-space: normal;background-color: rgb(254, 255, 255);"><strong><span style="font-family: 宋体;font-size: 15px;">欢迎投稿Linuxer：</span></strong><span style="font-family: 宋体;font-size: 15px;">稿件命中</span><span style="font-family: 宋体;font-size: 15px;text-decoration: underline;color: rgb(0, 209, 0);">获200元稿费红包+人民邮电出版社任意技术图书+读者打赏+帅酷</span><span style="font-family: 宋体;font-size: 15px;">。点击了解详情：<a href="http://mp.weixin.qq.com/s?__biz=MzAwMDUwNDgxOA==&amp;mid=2652663181&amp;idx=1&amp;sn=a3f7b46a0d41ebf2c5b5b97d377fca31&amp;chksm=810f2b10b678a206339e06328d8e04e4d7378c41e2d9e0a79501ebed7f036c61cf4e556ab6da&amp;scene=21#wechat_redirect" target="_blank">Linuxer-"Linux开发者自己的媒体"第五月稿件和赠书名单</a></span></h2><h2 style="white-space: normal;"><strong><span style="font-family: 宋体;font-size: 15px;"></span></strong></h2><hr  /><h2 style="white-space: normal;"><strong><span style="font-family: 宋体;font-size: 15px;">本文作者简介： </span></strong><span style="font-family: 宋体;font-size: 15px;">刘正元 (liuzhengyuan@kylinos.cn), linux内核爱好者，对内核IO子系统和内核调试工具这块比较感兴趣，向内核上游内核贡献过一些patch: https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?h=v4.16&amp;qt=grep&amp;q=zhengyuan, 目前就职于国内一家操作系统研发公司，负责文件IO协议栈的调试调优。</span></h2><p><span style="font-family: 宋体;font-size: 24px;"><span style=";"></span></span></p><p><img class="" data-copyright="0" data-ratio="1.3325" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/Ass1lsY6byuKYhicsJHsK6mUWJ40OHGoLnhzXlVS4F4sp6OKicrm1m98KQ11icc4b2wWL6uJZYZ1pbpV4bLxIiaZ0g/640?wx_fmt=jpeg" data-type="jpeg" data-w="800" style=""  /></p></section></section></section></section></section></section></section></section></section></section><h2><strong><span style="font-family: 宋体;font-size: 24px;">deadline 简介</span></strong><br  /></h2><p style="text-indent:28px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Calibri;font-size:15px;">deadline <span style="font-family:宋体;">是</span><span style="font-family:Calibri;">linux</span><span style="font-family:宋体;">内核通用块层中自带的四个</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">电梯调度器之一，其他的三个分别为</span><span style="font-family:Calibri;">noop(no operation)</span><span style="font-family:宋体;">、</span><span style="font-family:Calibri;">cfq(completely fair queuing)</span><span style="font-family:宋体;">、</span><span style="font-family:Calibri;">as(anticipatory scheduling)</span><span style="font-family:宋体;">，其中</span><span style="font-family:Calibri;">noop</span><span style="font-family:宋体;">是个空的调度器，仅仅直接转发</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求，不提供排序和合并的功能，适合</span><span style="font-family:Calibri;">ssd</span><span style="font-family:宋体;">和</span><span style="font-family:Calibri;">nvme</span><span style="font-family:宋体;">等快速存储设备。</span></span><span style="font-family:Calibri;font-size:15px;">&nbsp;</span><span style="font-family:Calibri;font-size:15px;"><br  /></span><span style="font-family:Calibri;font-size:15px;">deadline <span style="font-family:宋体;">调度器由通用块层的</span><span style="font-family:Calibri;">maintainer Jens Axboe</span><span style="font-family:宋体;">在</span><span style="font-family:Calibri;">2002</span><span style="font-family:宋体;">年首次写出并于同期合并进内核，此后几乎没经过大的修改，历久弥坚，现在已是通用块层单队列的默认</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">调度器。</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">相对与其他电梯调度器综合考虑</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求的吞吐量和时延性，最要体现在以下三个方面：</span></span></p><p style="margin-left:28px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Wingdings;font-size:15px;">ü&nbsp;</span><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">电梯性</span></span></p><p style="margin-left:28px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Wingdings;font-size:15px;">ü&nbsp;</span><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">饥饿性</span></span></p><p style="margin-left:28px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Wingdings;font-size:15px;">ü&nbsp;</span><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">超时性</span></span></p><p style="text-indent:28px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">各个性质的解析后面会具体介绍。测试数据表明，</span>deadline<span style="font-family:宋体;">在大多数多线程应用场景和数据库应用场景下表现的性能要优于</span><span style="font-family:Calibri;">cfq</span><span style="font-family:宋体;">和</span><span style="font-family:Calibri;">as</span><span style="font-family:宋体;">。</span></span></p><h2><strong><span style="font-family: 宋体;font-size: 24px;"><span style="font-family:宋体;">通用块层调度器框架</span></span></strong></h2><p style="text-indent:28px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">内核通用块层自带四种</span>IO<span style="font-family:宋体;">调度器，每个块设备在注册的时候都会为其指定一种调度器，块设备在运行的时候可以通过</span><span style="font-family:Calibri;">/sys</span><span style="font-family:宋体;">接口动态调整当前块设备使用的调度器，当然如果你喜欢，也可以自己实现一种满足自己需求的</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">调度器，并按照接口标准注册到通用块层。通用块层为了满足调度器的扩充，方便管理各式各样的调度器，提炼出了一个统一的框架，称之为电梯框架。每个调度器只需要需按照框架的标准实现自己调度策略的钩子函数，然后向电梯框架注册自己，后续的块设备就可以使用该注册的调度器。内核中大量使用了设计与实现分离的编程手法，熟悉内核</span><span style="font-family:Calibri;">md(multi device)</span><span style="font-family:宋体;">子系统的开发人员应该很了解这种手法，</span><span style="font-family:Calibri;">md</span><span style="font-family:宋体;">子系统规范出一个统一的接口，然后各个特性化的</span><span style="font-family:Calibri;">raid</span><span style="font-family:宋体;">实现这些接口，并向</span><span style="font-family:Calibri;">md</span><span style="font-family:宋体;">层注册自己。</span><span style="font-family:Calibri;">&nbsp;</span></span><span style="font-family:Calibri;font-size:15px;"><br  /></span><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">电梯调度器框架所包含的接口由内核源码下的</span>include/linux/elevator.h<span style="font-family:宋体;">中的</span><span style="font-family:Calibri;">struct elevator_ops</span><span style="font-family:宋体;">结构体定义，每个调度器根据自己的特性只需要实现其中部分接口即可。其中最基本的接口有四个：</span></span></p><p style="margin-left:56px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Wingdings;font-size:15px;">l&nbsp;</span><span style="font-family:Calibri;font-size:15px;">elevator_init_fn</span><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">：</span></span><span style="font-family:Calibri;font-size:15px;">&nbsp;<span style="font-family:宋体;">调度器初始化接口，注册时被调用，用于初始化调度器的私有数据结构</span>;</span></p><p style="margin-left:56px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Wingdings;font-size:15px;">l&nbsp;</span><span style="font-family:Calibri;font-size:15px;">elevator_exit_fn</span><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">：</span></span><span style="font-family:Calibri;font-size:15px;">&nbsp;<span style="font-family:宋体;">调度器退出接口，解注册时被调用，用于释放申请的数据结构</span>;</span></p><p style="margin-left:56px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Wingdings;font-size:15px;">l&nbsp;</span><span style="font-family:Calibri;font-size:15px;">elevator_add_req_fn</span><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">：</span></span><span style="font-family:Calibri;font-size:15px;">&nbsp;<span style="font-family:宋体;">调度器入口函数，用于向调度器中添加</span>IO<span style="font-family:宋体;">请求</span><span style="font-family:Calibri;">;</span></span></p><p style="margin-left:56px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Wingdings;font-size:15px;">l&nbsp;</span><span style="font-family:Calibri;font-size:15px;">elevator_dispatch_fn</span><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">：</span></span><span style="font-family:Calibri;font-size:15px;">&nbsp;<span style="font-family:宋体;">调度器出口函数，用于将调度器内的</span>IO<span style="font-family:宋体;">请求派发给设备驱动</span><span style="font-family:Calibri;">;</span></span></p><p style="margin-left:28px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Calibri;font-size:15px;">&nbsp;</span></p><h2><strong><span style="font-family: 宋体;font-size: 24px;">deadline 实现原理</span></strong></h2><p style="text-indent:28px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Calibri;font-size:15px;">deadline<span style="font-family:宋体;">调度器实现的接口有：</span></span></p><section style="background-color: rgb(255, 255, 255);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="margin-top: 10px;margin-bottom: 10px;box-sizing: border-box;"><section class="" style="display: inline-block;width: 100%;border-width: 1px;border-style: solid;border-color: rgb(192, 200, 209);padding: 10px;background-color: rgb(239, 239, 239);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">static struct elevator_type iosched_deadline = {</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.ops.sq = {</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_merge_fn = &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deadline_merge,</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_merged_fn&nbsp;= &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deadline_merged_request,</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_merge_req_fn = &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deadline_merged_requests,</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_dispatch_fn = &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deadline_dispatch_requests,</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_add_req_fn = &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deadline_add_request,</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_former_req_fn = &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elv_rb_former_request,</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_latter_req_fn = &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elv_rb_latter_request,</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_init_fn = &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deadline_init_queue,</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_exit_fn = &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deadline_exit_queue,</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_attrs = deadline_attrs,</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_name = "deadline",</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.elevator_owner = THIS_MODULE,</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">};</span></p></section></section></section></section></section></section></section><p style="text-indent:28px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">这些接口在调度器注册的时候告诉调度器框架本调度器对外暴露的方法，除了对外暴露的接口以外，</span>deadline<span style="font-family:宋体;">内部还有一些数据结构，用于快速的保存和操作</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求，如红黑树，链表等。这些数据结构是</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">内部使用的，可以统称为调度器的调度队列，对外不可见，需要调度器的接口才能操作。</span></span></p><section style="background-color: rgb(255, 255, 255);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="margin-top: 10px;margin-bottom: 10px;box-sizing: border-box;"><section class="" style="display: inline-block;width: 100%;border-width: 1px;border-style: solid;border-color: rgb(192, 200, 209);padding: 10px;background-color: rgb(239, 239, 239);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">struct deadline_data {</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct rb_root sort_list[2];</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct list_head fifo_list[2];</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct request *next_rq[2];</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned int batching; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* number of sequential requests made */</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned int starved; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* times reads have starved writes */</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int fifo_expire[2];</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int fifo_batch;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int writes_starved;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int front_merges;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">};</span></p></section></section></section></section></section></section></section><p style="text-indent:28px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">从面向对象的角度来理解</span>deadline<span style="font-family:宋体;">调度器的话，可以将</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">看作一个封装好的类，上面介绍的接口就是这个类的方法，上面介绍的数据结构就是这个类的数据成员。</span><span style="font-family:Calibri;">deadline_init_queue</span><span style="font-family:宋体;">是这个类的构造函数，在给块设备队列分配调度器的时候被调用，用户初始化类的数据成员。</span><span style="font-family:Calibri;">deadline_exit_queue</span><span style="font-family:宋体;">相当于析构函数，用于释放调度器实例化时申请的资源。其他的接口包括将</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求加入到调度器内部数据结构中，将</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求从调度器内部派发出去，将一个</span><span style="font-family:Calibri;">bio</span><span style="font-family:宋体;">合并到调度器内部的一个</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">中等。</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">内调度队列中最重要的两个成员为：</span></span></p><p style="text-indent:28px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Calibri;font-size:15px;">&nbsp;</span></p><p style="margin-left:56px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Wingdings;font-size:15px;">l&nbsp;</span><span style="font-family:Calibri;font-size:15px;">struct rb_root sort_list[2];</span></p><p style="margin-left:56px;text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Wingdings;font-size:15px;">l&nbsp;</span><span style="font-family:Calibri;font-size:15px;">struct list_head fifo_list[2];</span></p><p style="text-align:justify;text-justify:inter-ideograph;"><span style="font-family:Calibri;font-size:15px;">&nbsp;</span></p><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;"><span style="font-family:Calibri;font-size:15px;">sort_list<span style="font-family:宋体;">是两颗红黑树，用于对</span><span style="font-family:Calibri;">io</span><span style="font-family:宋体;">请求按起始扇区编号进行排序，</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">的电梯扫描就是基于这两个红黑树进行的，这里有两颗树，一颗读请求树，一颗写请求树，分别作用于读和写。 </span><span style="font-family:Calibri;">fifo_list</span><span style="font-family:宋体;">是普通的先进先出链表，也有两个，分别对应读和写。每个</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求在进入调度器的时候都会根据当前系统时间和超时时间给它赋上一个时间厝，然后根据</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">方向添加到读或者写</span><span style="font-family:Calibri;">fifo_list</span><span style="font-family:宋体;">，</span><span style="font-family:Calibri;">fifo_list</span><span style="font-family:宋体;">头部保存即将超时的</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求，调度器在派发</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求的时候会检测</span><span style="font-family:Calibri;">fifo_list</span><span style="font-family:宋体;">中是否有已经超时的</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求，如果有则必须进行派发处理，这就是</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">的字面意思，每个</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求都有一个死亡线的截至时间，读和写的超时时间由</span><span style="font-family:Calibri;">fifo_expire</span><span style="font-family:宋体;">成员定义，默认读为</span><span style="font-family:Calibri;">500ms</span><span style="font-family:宋体;">，写为</span><span style="font-family:Calibri;">5s</span><span style="font-family:宋体;">，因此读的优先级比写要高，因为读请求大部分情况下是同步的，需要尽快得到满足。</span></span></p><p><img class="" data-copyright="0" data-ratio="1.0090252707581226" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/Ass1lsY6byuKYhicsJHsK6mUWJ40OHGoLpY1Pr7xy4XX9BkwgbbObzxucvzfU0diaQULibUvtIJ9AlPATzrcQLXZg/640?wx_fmt=png" data-type="png" data-w="554" style=""  /></p><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;text-indent:28px;"><span style="font-family:Calibri;font-size:15px;">deadline<span style="font-family:宋体;">调度器的工作过程就是： 通用块层通过</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">注册的操作接口将</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求提交给</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">，</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">在收到请求之后根据请求的扇区编号将请求在</span><span style="font-family:Calibri;">sort_list</span><span style="font-family:宋体;">中排好序，同时给每个请求添加超时时间厝，并插入到</span><span style="font-family:Calibri;">fifo_list</span><span style="font-family:宋体;">尾部。一个</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求同时挂接在</span><span style="font-family:Calibri;">sort_list</span><span style="font-family:宋体;">和</span><span style="font-family:Calibri;">fifo_list</span><span style="font-family:宋体;">中。通用块层需要派发</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求（泻流或者</span><span style="font-family:Calibri;">direct IO</span><span style="font-family:宋体;">）的时候也是调用</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">注册的电梯派发接口，</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">在派发一个</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求时会基于电梯算法综合考虑</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求是否超时、写饥饿是否触发、是否满足批量条件来决定到底派发哪个</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求，派发之后会将该</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求同时从</span><span style="font-family:Calibri;">sort_list</span><span style="font-family:宋体;">和</span><span style="font-family:Calibri;">fifo_list</span><span style="font-family:宋体;">中删除。</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">服务的整个过程都是由通用块层驱动的，换言之</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">是被动的，在内核中不提供工作队列或工作线程。</span></span></p><h2><strong><span style="font-family: 宋体;font-size: 24px;">deadline IO请求的添加</span></strong></h2><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;text-indent:28px;"><span style="font-family:Calibri;font-size:15px;">deadline <span style="font-family:宋体;">的调度队列</span><span style="font-family:Calibri;">(</span><span style="font-family:宋体;">数据结构</span><span style="font-family:Calibri;">)</span><span style="font-family:宋体;">容纳的是</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">请求，本系列文章的《</span><span style="font-family:Calibri;">Linux</span><span style="font-family:宋体;">通用块层介绍（</span><span style="font-family:Calibri;">part1: bio</span><span style="font-family:宋体;">层）》、《</span><span style="font-family:Calibri;">Linux</span><span style="font-family:宋体;">通用块层介绍（</span><span style="font-family:Calibri;">part2: request</span><span style="font-family:宋体;">层）》从宏观上介绍了</span><span style="font-family:Calibri;">bio</span><span style="font-family:宋体;">请求如何转化为</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">请求并添加到调度器的调度队列中、如何合并进现有的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">请求（包括</span><span style="font-family:Calibri;">plug </span><span style="font-family:宋体;">链表中的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">和调度队列中的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">）。对于</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">来说，</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求的合并和排序都是在请求添加到</span><span style="font-family:Calibri;">deadline </span><span style="font-family:宋体;">的调度队列中的过程完成的。</span><span style="font-family:Calibri;">bio</span><span style="font-family:宋体;">请求进入</span><span style="font-family:Calibri;">deadline </span><span style="font-family:宋体;">调度队列有两条路径：</span></span></p><h3 style="margin-top:17px;margin-right:0;margin-bottom:8px;margin-left:0;"><strong><span style="font-family: Calibri;font-size: 15px;">bio<span style="font-family:宋体;">通过</span><span style="font-family:Calibri;">deadline_add_request</span><span style="font-family:宋体;">接口添加到调度队列</span></span></strong></h3><p><span style="font-family:Calibri;font-size:15px;">deadline_add_request<span style="font-family:宋体;">接口的参数形式是</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">，</span><span style="font-family:Calibri;">bio</span><span style="font-family:宋体;">在通用块层会申请一个新的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">或者合并到</span><span style="font-family:Calibri;">plug </span><span style="font-family:宋体;">链表中的现有的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">中，最后调用</span><span style="font-family:Calibri;">deadline_add_request</span><span style="font-family:宋体;">添加到调度队列。</span></span></p><section style="background-color: rgb(255, 255, 255);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="margin-top: 10px;margin-bottom: 10px;box-sizing: border-box;"><section class="" style="display: inline-block;width: 100%;border-width: 1px;border-style: solid;border-color: rgb(192, 200, 209);padding: 10px;background-color: rgb(239, 239, 239);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">/*</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;* add rq to rbtree and fifo</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;*/</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">static void</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">deadline_add_request(struct request_queue *q, struct request *rq)</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">{</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct deadline_data *dd = q-&gt;elevator-&gt;elevator_data;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const int data_dir = rq_data_dir(rq);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deadline_add_rq_rb(dd, rq);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* set expire time and add to fifo list</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rq-&gt;fifo_time = jiffies + dd-&gt;fifo_expire[data_dir];</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_add_tail(&amp;rq-&gt;queuelist, &amp;dd-&gt;fifo_list[data_dir]);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">}</span></p></section></section></section></section></section></section></section><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;"><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">接口很简单，首先判断</span>request<span style="font-family:宋体;">的</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">方向，根据</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">方向通过</span><span style="font-family:Calibri;">deadline_add_rq_rb</span><span style="font-family:宋体;">将</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">添加到读</span><span style="font-family:Calibri;">/</span><span style="font-family:宋体;">写红黑树中，</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">在红黑树中以请求的起始扇区作为节点的</span><span style="font-family:Calibri;">key value</span><span style="font-family:宋体;">，可以直接认为红黑树中的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">是按扇区增加的方向排好了序。然后给</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">添加一个超时时间厝，根据</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">方向添加到先进先出链表尾部，</span><span style="font-family:Calibri;">fifo_list</span><span style="font-family:宋体;">中同一</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">方向上的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">具有相同的</span><span style="font-family:Calibri;">fifo_expire</span><span style="font-family:宋体;">，所以先添加进来的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">先超时，每次都是从尾部添加，所以头部的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">先超时，这也是</span><span style="font-family:Calibri;">fifo_list</span><span style="font-family:宋体;">名字的由来吧。</span></span></p><h3 style="margin-top:17px;margin-right:0;margin-bottom:8px;margin-left:0;"><strong><span style="font-family: Calibri;font-size: 15px;">bio<span style="font-family:宋体;">通过</span><span style="font-family:Calibri;">deadline_merge*</span><span style="font-family:宋体;">接口合并到调度队列中的</span><span style="font-family:Calibri;">request</span></span></strong></h3><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;text-indent:28px;"><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">在《</span>Linux<span style="font-family:宋体;">通用块层介绍（</span><span style="font-family:Calibri;">part2: request</span><span style="font-family:宋体;">层）》中我们介绍了通用块层的</span><span style="font-family:Calibri;">blk_queue_bio</span><span style="font-family:宋体;">接口，其中有如何一段代码：</span></span></p><section style="background-color: rgb(255, 255, 255);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="margin-top: 10px;margin-bottom: 10px;box-sizing: border-box;"><section class="" style="display: inline-block;width: 100%;border-width: 1px;border-style: solid;border-color: rgb(192, 200, 209);padding: 10px;background-color: rgb(239, 239, 239);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">static blk_qc_t blk_queue_bio(struct request_queue *q, struct bio *bio)</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch (elv_merge(q, &amp;req, bio)) {</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case ELEVATOR_BACK_MERGE:</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!bio_attempt_back_merge(q, req, bio))</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elv_bio_merged(q, req, bio);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free = attempt_back_merge(q, req);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (free)</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__blk_put_request(q, free);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elv_merged_request(q, req, ELEVATOR_BACK_MERGE);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out_unlock;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case ELEVATOR_FRONT_MERGE:</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!bio_attempt_front_merge(q, req, bio))</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elv_bio_merged(q, req, bio);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free = attempt_front_merge(q, req);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (free)</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__blk_put_request(q, free);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elv_merged_request(q, req, ELEVATOR_FRONT_MERGE);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out_unlock;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;...</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">}</span></p></section></section></section></section></section></section></section><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;"><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">这段代码的意思就是尝试将</span>bio<span style="font-family:宋体;">合并到电梯调度队列中现有的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">中去，首先调用</span><span style="font-family:Calibri;">elv_merge-&gt;deadline_merge</span><span style="font-family:宋体;">判断是哪种合并（见《</span><span style="font-family:Calibri;">Linux</span><span style="font-family:宋体;">通用块层介绍（</span><span style="font-family:Calibri;">part2: request</span><span style="font-family:宋体;">层）》中介绍的合并类型），如果可以合并，则根据合并类型进行相应的合并，</span><span style="font-family:Calibri;">bio</span><span style="font-family:宋体;">合并到</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">的功能由通用块层的</span><span style="font-family:Calibri;">bio_attempt_front_merge/bio_attempt_back_merge</span><span style="font-family:宋体;">接口完成。对于</span><span style="font-family:Calibri;">deadline IO</span><span style="font-family:宋体;">调度器来说，</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">在红黑树中是以起始扇区作为</span><span style="font-family:Calibri;">key value</span><span style="font-family:宋体;">的，如果是前向合并则会改变合并后的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">的起始扇区号，因此</span><span style="font-family:Calibri;">bio</span><span style="font-family:宋体;">合并之后还需调用</span><span style="font-family:Calibri;">elv_bio_merged-&gt;eadline_merged_request</span><span style="font-family:宋体;">来重新更新</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">在红黑树中的</span><span style="font-family:Calibri;">key value</span><span style="font-family:宋体;">和位置。不管是前向合并还是后向合并，都有可能触发进阶合并，最后都会调用一次</span><span style="font-family:Calibri;">attempt_front/back_merge-&gt;deadline_merged_requests</span><span style="font-family:宋体;">来处理这种进阶合并，过程就是调用</span><span style="font-family:Calibri;">deadline_remove_request</span><span style="font-family:宋体;">接口将被合并的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">从</span><span style="font-family:Calibri;">sort_list</span><span style="font-family:宋体;">和</span><span style="font-family:Calibri;">fifo_list</span><span style="font-family:宋体;">中删除，同时更新合并后的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">的超时时间。</span></span></p><h2><strong><span style="font-family: 宋体;font-size: 24px;">deadline IO请求的派发</span></strong></h2><p><span style="font-family:Calibri;font-size:15px;">deadline <span style="font-family:宋体;">调度算法的核心思想就蕴含在请求的派发接口中，接口代码比较简洁，逻辑清晰，单次调用只派发一个</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">请求，调度数据结构记录了派发的上下文，调度时充分权衡了请求的电梯性、饥饿性、超时性。</span></span></p><section style="background-color: rgb(255, 255, 255);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="margin-top: 10px;margin-bottom: 10px;box-sizing: border-box;"><section class="" style="display: inline-block;width: 100%;border-width: 1px;border-style: solid;border-color: rgb(192, 200, 209);padding: 10px;background-color: rgb(239, 239, 239);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">/*</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;* deadline_dispatch_requests selects the best request according to</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;* read/write expire, fifo_batch, etc</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;*/</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">static int deadline_dispatch_requests(struct request_queue *q, int force)</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">{</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct deadline_data *dd = q-&gt;elevator-&gt;elevator_data;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const int reads = !list_empty(&amp;dd-&gt;fifo_list[READ]);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const int writes = !list_empty(&amp;dd-&gt;fifo_list[WRITE]);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct request *rq;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int data_dir;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* batches are currently reads XOR writes</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (dd-&gt;next_rq[WRITE])</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rq = dd-&gt;next_rq[WRITE];</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rq = dd-&gt;next_rq[READ];</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (rq &amp;&amp; dd-&gt;batching &lt; dd-&gt;fifo_batch)</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* we have a next request are still entitled to batch */</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto dispatch_request;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* at this point we are not running a batch. select the appropriate</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* data direction (read / write)</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (reads) {</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUG_ON(RB_EMPTY_ROOT(&amp;dd-&gt;sort_list[READ]));</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (writes &amp;&amp; (dd-&gt;starved++ &gt;= dd-&gt;writes_starved))</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto dispatch_writes;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data_dir = READ;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto dispatch_find_request;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* there are either no reads or writes have been starved</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (writes) {</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">dispatch_writes:</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUG_ON(RB_EMPTY_ROOT(&amp;dd-&gt;sort_list[WRITE]));</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dd-&gt;starved = 0;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data_dir = WRITE;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto dispatch_find_request;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">dispatch_find_request:</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* we are not running a batch, find best request for selected data_dir</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (deadline_check_fifo(dd, data_dir) || !dd-&gt;next_rq[data_dir]) {</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* A deadline has expired, the last request was in the other</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* direction, or we have run out of higher-sectored requests.</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Start again from the request with the earliest expiry time.</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rq = rq_entry_fifo(dd-&gt;fifo_list[data_dir].next);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* The last req was the same dir and we have a next request in</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* sort order. No expired requests so continue on from here.</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rq = dd-&gt;next_rq[data_dir];</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dd-&gt;batching = 0;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">dispatch_request:</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* rq is the selected appropriate request.</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dd-&gt;batching++;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deadline_move_request(dd, rq);</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</span></p><p style="box-sizing: border-box;"><span style="font-size: 12px;box-sizing: border-box;">}</span></p></section></section></section></section></section></section></section><h3 style="margin-top:17px;margin-right:0;margin-bottom:8px;margin-left:0;"><strong><span style="font-family: Calibri;font-size: 15px;">deadline<span style="font-family:宋体;">的电梯性</span></span></strong></h3><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;text-indent:28px;"><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">电梯调度器最重要的属性就是保持</span>IO<span style="font-family:宋体;">请求按适应磁头臂移动的方向去派发请求，从而尽可能的减少</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求的在磁盘上的寻道时间，提升</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">处理能力，类似于电梯移动算法，尽可能减少移动距离来提升运行效率，这就是</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">调度器称之为电梯调度器的原因。</span></span><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">硬盘的读写原理</span></span><span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;">这篇博文详细介绍了磁盘构造原理以及为什么需要</span>IO<span style="font-family:宋体;">调度的原因。</span><span style="font-family:Calibri;">&nbsp;</span></span><span style="font-family:Calibri;font-size:15px;"><br  /></span><span style="font-family:Calibri;font-size:15px;">deadline<span style="font-family:宋体;">的电梯性是通过批量</span><span style="font-family:Calibri;">(batching)</span><span style="font-family:宋体;">机制来实现的，前面介绍了</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求在红黑树中已排好序，</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">每次派发完一个</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">请求都会将红黑树中排好序的下一个</span><span style="font-family:Calibri;">request(</span><span style="font-family:宋体;">如果有</span><span style="font-family:Calibri;">)</span><span style="font-family:宋体;">暂存到</span><span style="font-family:Calibri;">next_rq</span><span style="font-family:宋体;">成员中，下一次再次调用</span><span style="font-family:Calibri;">deadline_dispatch_requests</span><span style="font-family:宋体;">时直接派发</span><span style="font-family:Calibri;">next_rq</span><span style="font-family:宋体;">成员中的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">，同时按红黑树的顺序更新</span><span style="font-family:Calibri;">next_rq</span><span style="font-family:宋体;">。如果一直按照这种思路派发，那么相反</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">方向的请求有可能很长时间得不到响应，同一</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">方向的请求也有可能出现超时。因此这种完全按红黑树的顺序派发请求的机制必须有个限制，</span><span style="font-family:Calibri;">deadline </span><span style="font-family:宋体;">中的</span><span style="font-family:Calibri;">batching</span><span style="font-family:宋体;">和</span><span style="font-family:Calibri;">fifo_batch</span><span style="font-family:宋体;">就是起这个作用的，每顺序派发一次，</span><span style="font-family:Calibri;">batching</span><span style="font-family:宋体;">加一，如果</span><span style="font-family:Calibri;">batching</span><span style="font-family:宋体;">超过了</span><span style="font-family:Calibri;">fifo_batch(</span><span style="font-family:宋体;">默认</span><span style="font-family:Calibri;">16)</span><span style="font-family:宋体;">就需要考量其他派发因子，如请求超时，</span><span style="font-family:Calibri;">fifo_batch</span><span style="font-family:宋体;">设置过大会提升</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求的吞吐率，增大</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求的延迟，反之相反。这种同</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">方向上的按顺序批次派发我们称只为批量机制，这种批量机制可能提前结束，如</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">方向上没有可继续派发的</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求了。</span></span></p><h3 style="margin-top:17px;margin-right:0;margin-bottom:8px;margin-left:0;"><strong><span style="font-family: Calibri;font-size: 15px;">deadline<span style="font-family:宋体;">的饥饿性</span></span></strong></h3><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;text-indent:28px;"><span style="font-family:Calibri;font-size:15px;">deadline<span style="font-family:宋体;">的饥饿性说的是写饥饿，写饥饿产生的原因是</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">给予读方向的</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求更高的优先级，即优先处理读请求，这是因为从实际应用角度来说读请求一般都是同步的，给予读更高的优先级有助于提升用户体验。总是一直优先处理读请求势必会造成写请求的饥饿，为此</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">引入</span><span style="font-family:Calibri;">starved</span><span style="font-family:宋体;">和</span><span style="font-family:Calibri;">writes_starved</span><span style="font-family:宋体;">成员变量来防止写饥饿，每优先处理一次读请求则计数器</span><span style="font-family:Calibri;">starved</span><span style="font-family:宋体;">加一，一旦</span><span style="font-family:Calibri;">starved</span><span style="font-family:宋体;">达到阀值</span><span style="font-family:Calibri;">writes_starved</span><span style="font-family:宋体;">（默认</span><span style="font-family:Calibri;">2</span><span style="font-family:宋体;">）且还有写请求，则下次派发时转向派发写请求。考虑到</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">的批量机制，默认情况下写请求最多让步于</span><span style="font-family:Calibri;">16 * 2 = 32</span><span style="font-family:宋体;">个读请求。</span></span></p><h3 style="margin-top:17px;margin-right:0;margin-bottom:8px;margin-left:0;"><strong><span style="font-family: Calibri;font-size: 15px;">deadline<span style="font-family:宋体;">的超时性</span></span></strong></h3><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;text-indent:28px;"><span style="font-family:Calibri;font-size:15px;">deadline<span style="font-family:宋体;">的饥饿性只会影响</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求派发的方向，</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">的电梯性和超时性决定派发哪个</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">请求。前面已经介绍了每个进入调度器的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">都会按照超时先后挂接到</span><span style="font-family:Calibri;">fifo_list</span><span style="font-family:宋体;">中，头部的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">先超时，尾部的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">后超时。在处理完一个批次的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">之后，</span><span style="font-family:Calibri;">deadline</span><span style="font-family:宋体;">会根据饥饿性确定的</span><span style="font-family:Calibri;">IO</span><span style="font-family:宋体;">方向上有没有</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">超时，如果有超时的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">则转向处理该</span><span style="font-family:Calibri;">request(fifo_list</span><span style="font-family:宋体;">头部</span><span style="font-family:Calibri;">request)</span><span style="font-family:宋体;">。如果还没有</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">超时</span><span style="font-family:Calibri;">,</span><span style="font-family:宋体;">且同方向的</span><span style="font-family:Calibri;">next_rq</span><span style="font-family:宋体;">有暂存的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">，则继续批量化处理</span><span style="font-family:Calibri;">next_rq</span><span style="font-family:宋体;">中的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">。如此以来，</span><span style="font-family:Calibri;">fifo_batch</span><span style="font-family:宋体;">并不是批量机制的上限，只是给超时和饥饿的</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">提供处理的机会，如果即没有超时又没有饥饿则当然继续按顺序批量化处理</span><span style="font-family:Calibri;">request</span><span style="font-family:宋体;">会提升效率。</span></span></p><hr  /><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;text-indent:28px;">相关阅读：<span style="font-family:Calibri;font-size:15px;"><span style="font-family:宋体;"></span></span><br  /></p><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;text-indent:28px;"><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDUwNDgxOA==&amp;mid=2652663917&amp;idx=1&amp;sn=7d649790eade1e939b4362d7f0657318&amp;chksm=810f36f0b678bfe6ba70a4f880a36b96b1d7fe72c651dd0ac9aacdf7708ad47b8e3e2f9474bc&amp;scene=21#wechat_redirect" target="_blank">块层介绍 第一篇: bio层</a><br  /></p><p style="margin-top:0;margin-right:0;margin-bottom:15px;margin-left:0;text-indent:28px;"><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDUwNDgxOA==&amp;mid=2652663917&amp;idx=2&amp;sn=2e1efebb3292c76f00357817278106f6&amp;chksm=810f36f0b678bfe674f017bdac57b1e2b94502aa0f1834cd93f2706bf096ae3304bde89a3a41&amp;scene=21#wechat_redirect" target="_blank">块层介绍 第二篇: request层</a><br  /></p><hr  /><section style="background-color: rgb(255, 255, 255);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="margin-top: 10px;margin-right: 0%;margin-left: 0%;box-sizing: border-box;"><section class="" style="text-align: center;font-size: 14px;box-sizing: border-box;"><p style="box-sizing: border-box;">长按识别二维码，关注Linuxer</p></section></section></section><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="text-align: center;margin-top: 10px;margin-bottom: 10px;box-sizing: border-box;"><section class="" style="max-width: 100%;vertical-align: middle;display: inline-block;width: 8%;overflow: hidden !important;box-sizing: border-box;"><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewbox="0 0 126.4 105.9" style="vertical-align: middle;max-width: 100%;box-sizing: border-box;" width="100%"><g style="box-sizing: border-box;"><g style="box-sizing: border-box;"><polygon style="box-sizing: border-box;" points="55,102 59.5,102 57.2,105.9" fill="rgb(234,23,23)"></polygon><polygon style="box-sizing: border-box;" points="49.5,92.5 65,92.5 62.7,96.4 51.7,96.4" fill="rgb(234,23,23)"></polygon><polygon style="box-sizing: border-box;" points="38.5,73.6 76,73.6 73.7,77.5 40.7,77.5" fill="rgb(234,23,23)"></polygon><polygon style="box-sizing: border-box;" points="44,83.1 70.5,83.1 68.2,87 46.2,87" fill="rgb(234,23,23)"></polygon><polygon style="box-sizing: border-box;" points="33,64.1 81.5,64.1 79.2,68 35.2,68" fill="rgb(234,23,23)"></polygon><polygon style="box-sizing: border-box;" points="27.5,54.6 87,54.6 84.7,58.5 29.7,58.5" fill="rgb(234,23,23)"></polygon><polygon style="box-sizing: border-box;" points="22,45.1 92.5,45.1 90.2,49 24.2,49" fill="rgb(234,23,23)"></polygon><polygon style="box-sizing: border-box;" points="16.5,35.6 98,35.6 95.7,39.5 18.8,39.5" fill="rgb(234,23,23)"></polygon><polygon style="box-sizing: border-box;" points="11,26.1 103.5,26.1 101.2,30 13.3,30" fill="rgb(234,23,23)"></polygon><polygon style="box-sizing: border-box;" points="5.5,16.7 109,16.7 106.7,20.6 7.8,20.6" fill="rgb(234,23,23)"></polygon><polygon style="box-sizing: border-box;" points="0,7.2 114.5,7.2 112.2,11.1 2.3,11.1" fill="rgb(234,23,23)"></polygon></g><g style="box-sizing: border-box;"><polygon style="box-sizing: border-box;" points="67,94.9 71.5,94.9 69.2,98.8" fill="rgb(255,202,0)"></polygon><polygon style="box-sizing: border-box;" points="61.5,85.4 77,85.4 74.7,89.3 63.7,89.3" fill="rgb(255,202,0)"></polygon><polygon style="box-sizing: border-box;" points="50.5,66.4 88,66.4 85.7,70.3 52.7,70.3" fill="rgb(255,202,0)"></polygon><polygon style="box-sizing: border-box;" points="56,75.9 82.5,75.9 80.2,79.8 58.2,79.8" fill="rgb(255,202,0)"></polygon><polygon style="box-sizing: border-box;" points="45,56.9 93.5,56.9 91.2,60.8 47.2,60.8" fill="rgb(255,202,0)"></polygon><polygon style="box-sizing: border-box;" points="39.5,47.4 99,47.4 96.7,51.3 41.7,51.3" fill="rgb(255,202,0)"></polygon><polygon style="box-sizing: border-box;" points="34,37.9 104.5,37.9 102.2,41.8 36.2,41.8" fill="rgb(255,202,0)"></polygon><polygon style="box-sizing: border-box;" points="28.5,28.5 110,28.5 107.7,32.4 30.7,32.4" fill="rgb(255,202,0)"></polygon><polygon style="box-sizing: border-box;" points="23,19 115.5,19 113.2,22.9 25.2,22.9" fill="rgb(255,202,0)"></polygon><polygon style="box-sizing: border-box;" points="17.5,9.5 121,9.5 118.7,13.4 19.8,13.4" fill="rgb(255,202,0)"></polygon><polygon style="box-sizing: border-box;" points="12,0 126.4,0 124.2,3.9 14.3,3.9" fill="rgb(255,202,0)"></polygon></g></g></svg></section></section></section><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="text-align: right;margin: 10px 0% -50px;transform: translate3d(-30px, 0px, 0px);-webkit-transform: translate3d(-30px, 0px, 0px);-moz-transform: translate3d(-30px, 0px, 0px);-o-transform: translate3d(-30px, 0px, 0px);box-sizing: border-box;"><section class="" style="max-width: 100%;vertical-align: middle;display: inline-block;width: 8%;overflow: hidden !important;box-sizing: border-box;"><img data-ratio="1.6766667" src="https://mmbiz.qpic.cn/mmbiz_gif/Ass1lsY6byuKYhicsJHsK6mUWJ40OHGoLn3vDDib25SANEKWyRnLOcq8DMz77eDTzE7W6lf7DX29opwG2SfB01yQ/640?wx_fmt=gif" data-type="gif" data-w="300" style="vertical-align: middle;width: 100%;box-sizing: border-box;" width="100%"  /></section></section></section><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="text-align: center;box-sizing: border-box;"><section class="" style="display: inline-block;width: 240px;height: 240px;vertical-align: top;overflow: hidden;background-position: 50% 50%;background-repeat: no-repeat;background-size: contain;background-attachment: scroll;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_gif/Ass1lsY6byuKYhicsJHsK6mUWJ40OHGoL3R9hhWpBHEhMHIv6scY4zGriatL2lPXfo7LUjfj0iarPUmX3Ywr19CbQ/640?wx_fmt=gif&quot;);box-sizing: border-box;"><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="margin: 60px 0% 10px;box-sizing: border-box;"><section class="" style="max-width: 100%;vertical-align: middle;display: inline-block;border-style: solid;border-width: 0px;border-radius: 0px;border-color: rgba(247, 247, 247, 0);width: 50%;box-shadow: rgb(210, 210, 210) 0px 0px 5px;overflow: hidden !important;box-sizing: border-box;"><img class="" data-copyright="0" data-cropselx1="0" data-cropselx2="120" data-cropsely1="0" data-cropsely2="120" data-ratio="1" src="https://mmbiz.qpic.cn/mmbiz_png/Ass1lsY6byuKYhicsJHsK6mUWJ40OHGoLctokBf5Pum1aHA5jibqRHgh4jm0XoeaWcNAFDEnrkQPQs2Dl4lUfmOA/640?wx_fmt=png" data-type="png" data-w="129" style="vertical-align: middle;width: 120px;box-sizing: border-box;height: 120px;" width="100%"  /></section></section></section></section></section></section><section class="Powered-by-XIUMI V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="margin: -50px 0% 10px;transform: translate3d(20px, 0px, 0px);-webkit-transform: translate3d(20px, 0px, 0px);-moz-transform: translate3d(20px, 0px, 0px);-o-transform: translate3d(20px, 0px, 0px);box-sizing: border-box;"><section class="" style="max-width: 100%;vertical-align: middle;display: inline-block;width: 10%;overflow: hidden !important;box-sizing: border-box;"><img data-ratio="1.6866667" src="https://mmbiz.qpic.cn/mmbiz_gif/Ass1lsY6byuKYhicsJHsK6mUWJ40OHGoLTBF247SECicQU0F6ue1xoh9hBWMEic8rgrHpTjcDdk04vFKk10PQtj5A/640?wx_fmt=gif" data-type="gif" data-w="300" style="vertical-align: middle;width: 100%;box-sizing: border-box;" width="100%"  /></section></section></section></section><p><br  /></p>
                </div>
                

                
  <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display: none;"></div>


                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_reward_area" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_reward_avatar">
                        <img src="" alt="" id="js_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" style="display: none;" id="js_reward_author">刘正元</div>
                                                            <p class="reward_tips js_reward_wording">打赏支持原创</p>
                                        <p class="reward_button_wrp">
                      <span id="js_author_reward_qrcode" class="reward_pop_panel">
                        <img id="js_author_reward_qrcode_img" src="" alt="赞赏二维码">
                        <strong>微信扫一扫赞赏作者</strong>
                      </span>
                        <a class="reward_button" id='js_reward_link' href="##"><span id="js_reward_link_text">赞赏</span></a>
                    </p>
                    <div id="js_reward_inner" class="reward_area_inner" style="display:none;">
                        <p class="weui-loadmore weui-loadmore_line reward_user_tips" id="js_reward_total_parent">
                          <span class="weui-loadmore__tips">
                            <a href="javascript:;" id="js_reward_total"></a>&nbsp;<span id="js_reward_total_text">人赞赏</span>
                        </span>
                        </p>
                        
                        <div id="js_reward_list" class="reward_user_list"></div>
                        <div id="js_reward_pagination" class="simple_pagination" style="display: none;">
                          <button disabled class="btn_sp_prev js_reward_pagination_prev">上一页</button>
                          <span class="sp_page_num_area">
                            <a class="sp_page_current js_reward_pagination_curpage" href="javascript:;">1</a>&#47;<span class="sp_page_num js_reward_pagination_totalpage">3</span>
                          </span>
                          <button class="btn_sp_next js_reward_pagination_next">下一页</button>
                        </div>
                    </div>
                </div>
                                <div class="reward_qrcode_area reward_area tc" id="js_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                                        <p class="reward_tips">打赏支持原创</p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" id="js_reward_qrcode_img"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                                            </div>
		<div class="comment">
			<h3 style="margin:26px 0;font-weight:100;padding-bottom:4px;border-bottom:1px solid #ccc;">精选留言</h3>
		    暂无...
		</div>
	</div>
	<div class='dy_all'>
		<a href='http://i.ijrou.com' target='_blank'>
			我的博客
		</a>
	</div>
</body>